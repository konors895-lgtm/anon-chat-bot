import telebot
from telebot import types

TOKEN = "8079784585:AAEucdjkd5rsoXGHS9nIOK34YhkNdvPq29k"
bot = telebot.TeleBot(TOKEN)

waiting = []
pairs = {}

def main_menu():
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("üîç –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞", "‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç")
    return kb

@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(
        message.chat.id,
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç!\n–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
        reply_markup=main_menu()
    )

@bot.message_handler(func=lambda m: m.text == "üîç –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞")
def find_partner(message):
    user_id = message.chat.id

    if user_id in pairs or user_id in waiting:
        return

    if waiting:
        partner = waiting.pop(0)
        pairs[user_id] = partner
        pairs[partner] = user_id

        bot.send_message(user_id, "‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω! –ü–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
        bot.send_message(partner, "‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω! –ü–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
    else:
        waiting.append(user_id)
        bot.send_message(user_id, "‚è≥ –ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...")

@bot.message_handler(func=lambda m: m.text == "‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç")
def stop_chat(message):
    user_id = message.chat.id

    if user_id in pairs:
        partner = pairs.pop(user_id)
        pairs.pop(partner, None)

        bot.send_message(partner, "‚ùå –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç.", reply_markup=main_menu())
        bot.send_message(user_id, "‚ùå –ß–∞—Ç –∑–∞–≤–µ—Ä—à—ë–Ω.", reply_markup=main_menu())
    else:
        bot.send_message(user_id, "‚Ñπ –¢—ã —Å–µ–π—á–∞—Å –Ω–µ –≤ —á–∞—Ç–µ.", reply_markup=main_menu())

@bot.message_handler(func=lambda m: True)
def relay_message(message):
    user_id = message.chat.id

    if user_id in pairs:
        partner = pairs[user_id]
        bot.send_message(partner, message.text)

bot.infinity_polling()
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.chat.id

    if user_id in pairs:
        bot.send_message(user_id, "–¢—ã —É–∂–µ –≤ —á–∞—Ç–µ.")
        return

    if user_id in waiting:
        bot.send_message(user_id, "üîç –ú—ã —É–∂–µ –∏—â–µ–º —Ç–µ–±–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...")
        return

    if waiting:
        partner = waiting.pop(0)
        pairs[user_id] = partner
        pairs[partner] = user_id

        bot.send_message(user_id, "‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω. –ü–∏—à–∏!")
        bot.send_message(partner, "‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω. –ü–∏—à–∏!")
    else:
        waiting.append(user_id)
        bot.send_message(user_id, "üîç –ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...")
